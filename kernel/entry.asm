extern krnl_main
SECTION .st
SECTION .bss align=16
stack_bottom:
    resb 16384
stack_top:

global _idt
_idt:
resb 2048

SECTION .text
global _start
_start:
pop dword eax
mov esp, stack_top
mov dword [bootinfo], dword eax
push dword [bootinfo]
mov dword [INTSize], INT1
sub dword [INTSize], INT0
call krnl_main
cli
hlt


_idtr:
    dw 2047
    dd _idt

global _idt_load
global _sidt
extern idtr
_idt_load:
    lidt [_idtr]
    ret

bootinfo: dd 32

extern CINTHandle
%macro INTWRAP 1
    xchg bx, bx
    pusha
    cld
    push %1
    call CINTHandle
    xchg bx, bx
    add esp, 4
    xchg bx, bx
    popa
    iret
%endmacro
global INT0
global INT1
global INTSize
INTSize dd 0

INT0: INTWRAP 0
INT1: INTWRAP 1
INTWRAP 2
INTWRAP 3
INTWRAP 4
INTWRAP 5
INTWRAP 6
INTWRAP 7
INTWRAP 8
INTWRAP 9
INTWRAP 10
INTWRAP 11
INTWRAP 12
INTWRAP 13
INTWRAP 14
INTWRAP 15
INTWRAP 16
INTWRAP 17
INTWRAP 18
INTWRAP 19
INTWRAP 20
INTWRAP 21
INTWRAP 22
INTWRAP 23
INTWRAP 24
INTWRAP 25
INTWRAP 26
INTWRAP 27
INTWRAP 28
INTWRAP 29
INTWRAP 30
INTWRAP 31
INTWRAP 32
INTWRAP 33
INTWRAP 34
INTWRAP 35
INTWRAP 36
INTWRAP 37
INTWRAP 38
INTWRAP 39
INTWRAP 40
INTWRAP 41
INTWRAP 42
INTWRAP 43
INTWRAP 44
INTWRAP 45
INTWRAP 46
INTWRAP 47
INTWRAP 48
INTWRAP 49
INTWRAP 50
INTWRAP 51
INTWRAP 52
INTWRAP 53
INTWRAP 54
INTWRAP 55
INTWRAP 56
INTWRAP 57
INTWRAP 58
INTWRAP 59
INTWRAP 60
INTWRAP 71
INTWRAP 72
INTWRAP 73
INTWRAP 74
INTWRAP 75
INTWRAP 76
INTWRAP 77
INTWRAP 78
INTWRAP 79
INTWRAP 80
INTWRAP 81
INTWRAP 82
INTWRAP 83
INTWRAP 84
INTWRAP 85
INTWRAP 86
INTWRAP 87
INTWRAP 88
INTWRAP 89
INTWRAP 90
INTWRAP 91
INTWRAP 92
INTWRAP 93
INTWRAP 94
INTWRAP 95
INTWRAP 96
INTWRAP 97
INTWRAP 98
INTWRAP 99
INTWRAP 100
INTWRAP 101
INTWRAP 102
INTWRAP 103
INTWRAP 104
INTWRAP 105
INTWRAP 106
INTWRAP 107
INTWRAP 108
INTWRAP 109
INTWRAP 110
INTWRAP 111
INTWRAP 112
INTWRAP 113
INTWRAP 114
INTWRAP 115
INTWRAP 116
INTWRAP 117
INTWRAP 118
INTWRAP 119
INTWRAP 120
INTWRAP 121
INTWRAP 122
INTWRAP 123
INTWRAP 124
INTWRAP 125
INTWRAP 126
INTWRAP 177
INTWRAP 128
INTWRAP 129
INTWRAP 130
INTWRAP 131
INTWRAP 132
INTWRAP 133
INTWRAP 134
INTWRAP 135
INTWRAP 136
INTWRAP 137
INTWRAP 138
INTWRAP 139
INTWRAP 140
INTWRAP 141
INTWRAP 142
INTWRAP 143
INTWRAP 144
INTWRAP 145
INTWRAP 146
INTWRAP 147
INTWRAP 148
INTWRAP 149
INTWRAP 150
INTWRAP 151
INTWRAP 152
INTWRAP 153
INTWRAP 154
INTWRAP 155
INTWRAP 156
INTWRAP 157
INTWRAP 158
INTWRAP 159
INTWRAP 160
INTWRAP 171
INTWRAP 172
INTWRAP 173
INTWRAP 174
INTWRAP 175
INTWRAP 176
INTWRAP 177
INTWRAP 178
INTWRAP 179
INTWRAP 180
INTWRAP 181
INTWRAP 182
INTWRAP 183
INTWRAP 184
INTWRAP 185
INTWRAP 186
INTWRAP 187
INTWRAP 188
INTWRAP 189
INTWRAP 190
INTWRAP 191
INTWRAP 192
INTWRAP 193
INTWRAP 194
INTWRAP 195
INTWRAP 196
INTWRAP 197
INTWRAP 198
INTWRAP 199
INTWRAP 200
INTWRAP 201
INTWRAP 202
INTWRAP 203
INTWRAP 204
INTWRAP 205
INTWRAP 206
INTWRAP 207
INTWRAP 208
INTWRAP 209
INTWRAP 210
INTWRAP 211
INTWRAP 212
INTWRAP 213
INTWRAP 214
INTWRAP 215
INTWRAP 216
INTWRAP 217
INTWRAP 218
INTWRAP 219
INTWRAP 220
INTWRAP 221
INTWRAP 222
INTWRAP 223
INTWRAP 224
INTWRAP 225
INTWRAP 226
INTWRAP 227
INTWRAP 228
INTWRAP 229
INTWRAP 230
INTWRAP 231
INTWRAP 232
INTWRAP 233
INTWRAP 234
INTWRAP 235
INTWRAP 236
INTWRAP 237
INTWRAP 238
INTWRAP 239
INTWRAP 240
INTWRAP 241
INTWRAP 242
INTWRAP 243
INTWRAP 244
INTWRAP 245
INTWRAP 246
INTWRAP 247
INTWRAP 248
INTWRAP 249
INTWRAP 250
INTWRAP 251
INTWRAP 252
INTWRAP 253
INTWRAP 254
INTWRAP 255