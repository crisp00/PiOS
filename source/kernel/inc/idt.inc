section .text

global PIOS_IDT
PIOS_IDT:
    times 2048 db 0

global PIOS_IDTR
PIOS_IDTR:
    dw 2047
    dd PIOS_IDT


global PIOS_install_idt
PIOS_install_idt:
    cli
    lidt [PIOS_IDTR]
    ret

global get_cpu_state
get_cpu_state:
    mov [eax_], eax
    mov [ebx_], ebx
    mov [ecx_], ecx
    mov [edx_], edx

    mov [esi_], esi
    mov [edi_], edi
    mov [esp_], esp
    mov [ebp_], ebp
    
    mov eax, [esp]
    mov [eip_], eax
    pushfd
    pop eax
    mov [eflags_], eax
    mov eax, cr3
    mov [cr3_], eax
    mov eax, eax_
    ret

global set_cpu_state
set_cpu_state:
    mov eax, [esp + 4]
    mov ebx, [eax + 4]
    mov ecx, [eax + 8]
    mov edx, [eax + 12]

    mov esi, [eax + 16]
    mov edi, [eax + 20]
    mov esp, [eax + 24]
    mov ebp, [eax + 28]
    push dword [eax + 32]
    popfd
    mov eax, [eax]
    ret

section .idt



extern CINTHandle
%macro INTWRAP 1
    pusha
    push ds
    push es
    push fs
    push gs
    mov ax, 10h
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov eax, esp
    push eax

    push DWORD 0
    push DWORD %1
    mov eax, CINTHandle
    call eax
    add esp, 8
    ; push DWORD intDoneMsg
    ; mov eax, printf
    ; call eax
    ; add esp, 4

    pop eax
    ; mov esp, eax
    pop gs
    pop fs
    pop es
    pop ds
    popa
    iretd
%endmacro

%macro INTWRAP_ERR 1
    push eax
    mov eax, [esp + 4]
    mov [errnum], eax
    mov eax, [esp + 8]
    mov [eipnum], eax
    pusha
    push ds
    push es
    push fs
    push gs
    mov ax, 10h
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov eax, esp

    push DWORD [eipnum]
    push DWORD [errnum]
    push DWORD %1
    mov eax, CINTHandle
    call eax
    add esp, 12
    ; push DWORD intDoneMsg
    ; mov eax, printf
    ; call eax
    ; add esp, 4

    ; mov esp, eax
    pop gs
    pop fs
    pop es
    pop ds
    popa
    pop eax
    add esp, 4
    iretd
%endmacro

%macro INTWRAP_SAVETASK 1  
    push eax
    push ebx
    push ecx
    push edx
    push esi
    push edi
    push ebp
    push ds
    push es
    push fs
    push gs
    mov [esp_], esp

    push dword eax_
    push dword 0
    push dword %1
    mov eax, CINTHandle
    call eax

    mov esp, [esp_]
    pop gs
    pop fs
    pop es
    pop ds
    pop ebp
    pop edi
    pop esi
    pop edx
    pop ecx
    pop ebx
    pop eax
    iret
%endmacro

errnum dd 0
eipnum dd 0


global INTSize


global INT0
global INT1
global INT2
global INT3
global INT4
global INT5
global INT6
global INT7
global INT8
global INT9
global INT10
global INT11
global INT12
global INT13
global INT14
global INT15
global INT16
global INT17
global INT18
global INT19
global INT20
global INT21
global INT22
global INT23
global INT24
global INT25
global INT26
global INT27
global INT28
global INT29
global INT30
global INT31
global INT32
global INT33
global INT34
global INT35
global INT36
global INT37
global INT38
global INT39
global INT40
global INT41
global INT42
global INT43
global INT44
global INT45
global INT46
global INT47
global INT48
global INT49
global INT50
global INT51
global INT52
global INT53
global INT54
global INT55
global INT56
global INT57
global INT58
global INT59
global INT60
global INT61
global INT62
global INT63
global INT64
global INT65
global INT66
global INT67
global INT68
global INT69
global INT70
global INT71
global INT72
global INT73
global INT74
global INT75
global INT76
global INT77
global INT78
global INT79
global INT80
global INT81
global INT82
global INT83
global INT84
global INT85
global INT86
global INT87
global INT88
global INT89
global INT90
global INT91
global INT92
global INT93
global INT94
global INT95
global INT96
global INT97
global INT98
global INT99
global INT100
global INT101
global INT102
global INT103
global INT104
global INT105
global INT106
global INT107
global INT108
global INT109
global INT110
global INT111
global INT112
global INT113
global INT114
global INT115
global INT116
global INT117
global INT118
global INT119
global INT120
global INT121
global INT122
global INT123
global INT124
global INT125
global INT126
global INT127
global INT128
global INT129
global INT130
global INT131
global INT132
global INT133
global INT134
global INT135
global INT136
global INT137
global INT138
global INT139
global INT140
global INT141
global INT142
global INT143
global INT144
global INT145
global INT146
global INT147
global INT148
global INT149
global INT150
global INT151
global INT152
global INT153
global INT154
global INT155
global INT156
global INT157
global INT158
global INT159
global INT160
global INT161
global INT162
global INT163
global INT164
global INT165
global INT166
global INT167
global INT168
global INT169
global INT170
global INT171
global INT172
global INT173
global INT174
global INT175
global INT176
global INT177
global INT178
global INT179
global INT180
global INT181
global INT182
global INT183
global INT184
global INT185
global INT186
global INT187
global INT188
global INT189
global INT190
global INT191
global INT192
global INT193
global INT194
global INT195
global INT196
global INT197
global INT198
global INT199
global INT200
global INT201
global INT202
global INT203
global INT204
global INT205
global INT206
global INT207
global INT208
global INT209
global INT210
global INT211
global INT212
global INT213
global INT214
global INT215
global INT216
global INT217
global INT218
global INT219
global INT220
global INT221
global INT222
global INT223
global INT224
global INT225
global INT226
global INT227
global INT228
global INT229
global INT230
global INT231
global INT232
global INT233
global INT234
global INT235
global INT236
global INT237
global INT238
global INT239
global INT240
global INT241
global INT242
global INT243
global INT244
global INT245
global INT246
global INT247
global INT248
global INT249
global INT250
global INT251
global INT252
global INT253
global INT254
global INT255

INTSize dd 0
ESPSave dd 0
intDoneMsg db "INTDONE", 10, 00

section .text

INT0: INTWRAP 0
INT1: INTWRAP 1
INT2: INTWRAP 2
INT3: INTWRAP 3
INT4: INTWRAP 4
INT5: INTWRAP 5
INT6: INTWRAP 6
INT7: INTWRAP 7
INT8: INTWRAP 8
INT9: INTWRAP 9
INT10: INTWRAP 10
INT11: INTWRAP 11
INT12: INTWRAP 12
INT13: INTWRAP_ERR 13
INT14: INTWRAP_ERR 14
INT15: INTWRAP 15
INT16: INTWRAP 16
INT17: INTWRAP 17
INT18: INTWRAP 18
INT19: INTWRAP 19
INT20: INTWRAP 20
INT21: INTWRAP 21
INT22: INTWRAP 22
INT23: INTWRAP 23
INT24: INTWRAP 24
INT25: INTWRAP 25
INT26: INTWRAP 26
INT27: INTWRAP 27
INT28: INTWRAP 28
INT29: INTWRAP 29
INT30: INTWRAP 30
INT31: INTWRAP 31
INT32: INTWRAP_SAVETASK 32
INT33: INTWRAP 33
INT34: INTWRAP 34
INT35: INTWRAP 35
INT36: INTWRAP 36
INT37: INTWRAP 37
INT38: INTWRAP 38
INT39: INTWRAP 39
INT40: INTWRAP 40
INT41: INTWRAP 41
INT42: INTWRAP 42
INT43: INTWRAP 43
INT44: INTWRAP 44
INT45: INTWRAP 45
INT46: INTWRAP 46
INT47: INTWRAP 47
INT48: INTWRAP 48
INT49: INTWRAP 49
INT50: INTWRAP 50
INT51: INTWRAP 51
INT52: INTWRAP 52
INT53: INTWRAP 53
INT54: INTWRAP 54
INT55: INTWRAP 55
INT56: INTWRAP 56
INT57: INTWRAP 57
INT58: INTWRAP 58
INT59: INTWRAP 59
INT60: INTWRAP 60
INT61: INTWRAP 61
INT62: INTWRAP 62
INT63: INTWRAP 63
INT64: INTWRAP 64
INT65: INTWRAP 65
INT66: INTWRAP 66
INT67: INTWRAP 67
INT68: INTWRAP 68
INT69: INTWRAP 69
INT70: INTWRAP 70
INT71: INTWRAP 71
INT72: INTWRAP 72
INT73: INTWRAP 73
INT74: INTWRAP 74
INT75: INTWRAP 75
INT76: INTWRAP 76
INT77: INTWRAP 77
INT78: INTWRAP 78
INT79: INTWRAP 79
INT80: INTWRAP 80
INT81: INTWRAP 81
INT82: INTWRAP 82
INT83: INTWRAP 83
INT84: INTWRAP 84
INT85: INTWRAP 85
INT86: INTWRAP 86
INT87: INTWRAP 87
INT88: INTWRAP 88
INT89: INTWRAP 89
INT90: INTWRAP 90
INT91: INTWRAP 91
INT92: INTWRAP 92
INT93: INTWRAP 93
INT94: INTWRAP 94
INT95: INTWRAP 95
INT96: INTWRAP 96
INT97: INTWRAP 97
INT98: INTWRAP 98
INT99: INTWRAP 99
INT100: INTWRAP 100
INT101: INTWRAP 101
INT102: INTWRAP 102
INT103: INTWRAP 103
INT104: INTWRAP 104
INT105: INTWRAP 105
INT106: INTWRAP 106
INT107: INTWRAP 107
INT108: INTWRAP 108
INT109: INTWRAP 109
INT110: INTWRAP 110
INT111: INTWRAP 111
INT112: INTWRAP 112
INT113: INTWRAP 113
INT114: INTWRAP 114
INT115: INTWRAP 115
INT116: INTWRAP 116
INT117: INTWRAP 117
INT118: INTWRAP 118
INT119: INTWRAP 119
INT120: INTWRAP 120
INT121: INTWRAP 121
INT122: INTWRAP 122
INT123: INTWRAP 123
INT124: INTWRAP 124
INT125: INTWRAP 125
INT126: INTWRAP 126
INT127: INTWRAP 127
INT128: INTWRAP 128
INT129: INTWRAP 129
INT130: INTWRAP 130
INT131: INTWRAP 131
INT132: INTWRAP 132
INT133: INTWRAP 133
INT134: INTWRAP 134
INT135: INTWRAP 135
INT136: INTWRAP 136
INT137: INTWRAP 137
INT138: INTWRAP 138
INT139: INTWRAP 139
INT140: INTWRAP 140
INT141: INTWRAP 141
INT142: INTWRAP 142
INT143: INTWRAP 143
INT144: INTWRAP 144
INT145: INTWRAP 145
INT146: INTWRAP 146
INT147: INTWRAP 147
INT148: INTWRAP 148
INT149: INTWRAP 149
INT150: INTWRAP 150
INT151: INTWRAP 151
INT152: INTWRAP 152
INT153: INTWRAP 153
INT154: INTWRAP 154
INT155: INTWRAP 155
INT156: INTWRAP 156
INT157: INTWRAP 157
INT158: INTWRAP 158
INT159: INTWRAP 159
INT160: INTWRAP 160
INT161: INTWRAP 161
INT162: INTWRAP 162
INT163: INTWRAP 163
INT164: INTWRAP 164
INT165: INTWRAP 165
INT166: INTWRAP 166
INT167: INTWRAP 167
INT168: INTWRAP 168
INT169: INTWRAP 169
INT170: INTWRAP 170
INT171: INTWRAP 171
INT172: INTWRAP 172
INT173: INTWRAP 173
INT174: INTWRAP 174
INT175: INTWRAP 175
INT176: INTWRAP 176
INT177: INTWRAP 177
INT178: INTWRAP 178
INT179: INTWRAP 179
INT180: INTWRAP 180
INT181: INTWRAP 181
INT182: INTWRAP 182
INT183: INTWRAP 183
INT184: INTWRAP 184
INT185: INTWRAP 185
INT186: INTWRAP 186
INT187: INTWRAP 187
INT188: INTWRAP 188
INT189: INTWRAP 189
INT190: INTWRAP 190
INT191: INTWRAP 191
INT192: INTWRAP 192
INT193: INTWRAP 193
INT194: INTWRAP 194
INT195: INTWRAP 195
INT196: INTWRAP 196
INT197: INTWRAP 197
INT198: INTWRAP 198
INT199: INTWRAP 199
INT200: INTWRAP 200
INT201: INTWRAP 201
INT202: INTWRAP 202
INT203: INTWRAP 203
INT204: INTWRAP 204
INT205: INTWRAP 205
INT206: INTWRAP 206
INT207: INTWRAP 207
INT208: INTWRAP 208
INT209: INTWRAP 209
INT210: INTWRAP 210
INT211: INTWRAP 211
INT212: INTWRAP 212
INT213: INTWRAP 213
INT214: INTWRAP 214
INT215: INTWRAP 215
INT216: INTWRAP 216
INT217: INTWRAP 217
INT218: INTWRAP 218
INT219: INTWRAP 219
INT220: INTWRAP 220
INT221: INTWRAP 221
INT222: INTWRAP 222
INT223: INTWRAP 223
INT224: INTWRAP 224
INT225: INTWRAP 225
INT226: INTWRAP 226
INT227: INTWRAP 227
INT228: INTWRAP 228
INT229: INTWRAP 229
INT230: INTWRAP 230
INT231: INTWRAP 231
INT232: INTWRAP 232
INT233: INTWRAP 233
INT234: INTWRAP 234
INT235: INTWRAP 235
INT236: INTWRAP 236
INT237: INTWRAP 237
INT238: INTWRAP 238
INT239: INTWRAP 239
INT240: INTWRAP 240
INT241: INTWRAP 241
INT242: INTWRAP 242
INT243: INTWRAP 243
INT244: INTWRAP 244
INT245: INTWRAP 245
INT246: INTWRAP 246
INT247: INTWRAP 247
INT248: INTWRAP 248
INT249: INTWRAP 249
INT250: INTWRAP 250
INT251: INTWRAP 251
INT252: INTWRAP 252
INT253: INTWRAP 253
INT254: INTWRAP 254
INT255: INTWRAP 255
